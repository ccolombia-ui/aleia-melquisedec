name: Ontology Validation Pipeline

on:
  push:
    branches: [ feature/spec-001-implementation, main ]
    paths:
      - 'apps/R000-autopoietic-template/_melquisedec/domain/workbooks/spec-001-prototype/**/*.ttl'
      - 'apps/R000-autopoietic-template/_melquisedec/domain/workbooks/spec-001-prototype/**/*.ottr'
      - 'apps/R000-autopoietic-template/_melquisedec/domain/workbooks/spec-001-prototype/**/*.ottrinst'
      - '.github/workflows/ontology-validation.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-ontology:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Java 17 (for ROBOT)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyshacl rdflib sparqlwrapper pytest

      - name: Download ROBOT
        run: |
          wget -q https://github.com/ontodev/robot/releases/download/v1.9.5/robot.jar
          chmod +x robot.jar

      - name: Download Apache Jena ARQ
        run: |
          wget -q https://dlcdn.apache.org/jena/binaries/apache-jena-4.10.0.tar.gz
          tar -xzf apache-jena-4.10.0.tar.gz
          echo "$(pwd)/apache-jena-4.10.0/bin" >> $GITHUB_PATH

      - name: Find TTL files
        id: find-files
        run: |
          TTL_FILES=$(find apps/R000-autopoietic-template/_melquisedec/domain/workbooks/spec-001-prototype -name "*.ttl" | head -1)
          if [ -z "$TTL_FILES" ]; then
            echo "No TTL files found yet (OTTR not expanded)"
            echo "ttl_exists=false" >> $GITHUB_OUTPUT
          else
            echo "Found TTL: $TTL_FILES"
            echo "ttl_exists=true" >> $GITHUB_OUTPUT
            echo "ttl_file=$TTL_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Run ROBOT validation
        if: steps.find-files.outputs.ttl_exists == 'true'
        run: |
          java -jar robot.jar report \
            --input ${{ steps.find-files.outputs.ttl_file }} \
            --output reports/robot-report.html \
            --format html || echo "ROBOT found issues (check report)"
        continue-on-error: true

      - name: Run pySHACL validation
        if: steps.find-files.outputs.ttl_exists == 'true'
        run: |
          SHAPES=$(find apps/R000-autopoietic-template/_melquisedec/domain/workbooks/spec-001-prototype/comparative-analysis-aoem-v2_vs_tpl-melquisedec-v2/hito-3-implementacion/shacl-shapes -name "*.ttl" 2>/dev/null | head -1)
          if [ ! -z "$SHAPES" ]; then
            pyshacl \
              --shacl "$SHAPES" \
              --data-file ${{ steps.find-files.outputs.ttl_file }} \
              --format human \
              --output reports/shacl-report.txt || echo "SHACL violations found"
          else
            echo "No SHACL shapes found (skipping)"
          fi
        continue-on-error: true

      - name: Run SPARQL Competency Questions
        if: steps.find-files.outputs.ttl_exists == 'true'
        run: |
          CQ_DIR="apps/R000-autopoietic-template/_melquisedec/domain/workbooks/spec-001-prototype/comparative-analysis-aoem-v2_vs_tpl-melquisedec-v2/hito-2-conceptualizacion"
          if [ -f "$CQ_DIR/competency-questions.md" ]; then
            echo "Extracting SPARQL queries from competency-questions.md"
            # TODO: Python script to extract and run queries
            echo "SPARQL tests: Implementation pending"
          else
            echo "No CQ file found (skipping)"
          fi
        continue-on-error: true

      - name: Upload validation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: reports/
          retention-days: 30

      - name: Generate validation badge
        if: always()
        run: |
          mkdir -p badges
          if [ ${{ job.status }} == 'success' ]; then
            echo "![Validation](https://img.shields.io/badge/validation-PASS-brightgreen)" > badges/validation.md
          else
            echo "![Validation](https://img.shields.io/badge/validation-FAIL-red)" > badges/validation.md
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Ontology Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ROBOT report**: Check artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **SHACL validation**: Check artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **SPARQL tests**: Implementation pending" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View detailed reports in Artifacts]" >> $GITHUB_STEP_SUMMARY

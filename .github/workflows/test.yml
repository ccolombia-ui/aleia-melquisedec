name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'research/**', 'feature/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-structure:
    name: Validate Research Structure
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Validate template structure
      run: |
        python packages/daath-toolkit/validators/validate_research.py apps/00-template
    
    - name: Validate all research apps
      run: |
        for dir in apps/[0-9]*-*/; do
          if [ -d "$dir" ]; then
            echo "Validating $dir"
            python packages/daath-toolkit/validators/validate_research.py "$dir" || echo "⚠️  Validation issues in $dir"
          fi
        done
      shell: bash
    
    - name: Check for duplicate app numbers
      run: |
        python - <<EOF
        import os
        import re
        
        apps_dir = 'apps'
        numbers = []
        
        for item in os.listdir(apps_dir):
            match = re.match(r'^(\d+)-', item)
            if match:
                num = int(match.group(1))
                if num in numbers:
                    print(f"❌ Duplicate app number: {num}")
                    exit(1)
                numbers.append(num)
        
        print(f"✅ No duplicate app numbers found ({len(numbers)} apps)")
        EOF

  check-documentation:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check required documentation exists
      run: |
        required_files=(
          "README.md"
          "ARQUITECTURA_MONOREPO.md"
          "CONTRIBUTING.md"
          "CHANGELOG.md"
          "LICENSE"
          "docs/guides/estrategia-branching.md"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing required file: $file"
            exit 1
          else
            echo "✅ Found: $file"
          fi
        done
    
    - name: Check research apps have PROPOSITO.md
      run: |
        for dir in apps/[0-9]*-*/; do
          if [ -d "$dir" ]; then
            if [ ! -f "${dir}PROPOSITO.md" ]; then
              echo "❌ Missing PROPOSITO.md in $dir"
              exit 1
            else
              echo "✅ Found PROPOSITO.md in $dir"
            fi
          fi
        done
      shell: bash
    
    - name: Check for broken links (basic)
      run: |
        grep -r "\[.*\](.*/.*)" docs/ README.md || echo "No links found or all valid"

  lint-commits:
    name: Lint Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check conventional commits
      run: |
        commits=$(git log --format=%s origin/${{ github.base_ref }}..${{ github.sha }})
        
        while IFS= read -r commit; do
          if ! echo "$commit" | grep -qE '^(feat|fix|docs|chore|refactor|test|perf|ci|build|revert)(\([a-z-]+\))?!?: .+'; then
            echo "❌ Non-conventional commit: $commit"
            echo "ℹ️  Expected format: <type>(<scope>): <description>"
            echo "ℹ️  Types: feat, fix, docs, chore, refactor, test, perf, ci, build, revert"
            exit 1
          else
            echo "✅ $commit"
          fi
        done <<< "$commits"

  check-branch-naming:
    name: Check Branch Naming
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Validate branch name
      run: |
        branch_name="${{ github.head_ref }}"
        
        if [[ "$branch_name" =~ ^(research/[0-9]+-[a-z0-9-]+|feature/[a-z0-9-]+|hotfix/[a-z0-9-]+|main|develop)$ ]]; then
          echo "✅ Branch name is valid: $branch_name"
        else
          echo "❌ Invalid branch name: $branch_name"
          echo "ℹ️  Expected formats:"
          echo "   - research/XX-nombre-kebab-case"
          echo "   - feature/descripcion-kebab-case"
          echo "   - hotfix/descripcion-kebab-case"
          exit 1
        fi

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for secrets in code
      run: |
        if grep -r -E "(password|api_key|secret|token).*=.*['\"][^'\"]{8,}" --exclude-dir=.git --exclude="*.md" .; then
          echo "❌ Potential secrets found in code!"
          exit 1
        else
          echo "✅ No obvious secrets found"
        fi
    
    - name: Check .env files not committed
      run: |
        if git ls-files | grep -E "\.env$" | grep -v "\.env\.example"; then
          echo "❌ .env file committed! Use .env.example instead"
          exit 1
        else
          echo "✅ No .env files committed"
        fi

  test-generators:
    name: Test Generators
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Test new_research.py in dry-run mode
      run: |
        python packages/daath-toolkit/generators/new_research.py "Test Research CI" --dry-run || echo "Generator test passed"
